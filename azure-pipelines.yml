trigger:
  branches:
    include:
      - dev
      - main

pool:
  name: default

steps:

# 1ï¸âƒ£ Set dynamic releaseName and namespace based on branch
- script: |
    if [ "$(Build.SourceBranchName)" == "dev" ]; then
      echo "##vso[task.setvariable variable=releaseName]app-dev"
      echo "##vso[task.setvariable variable=namespace]dev"
    else
      echo "##vso[task.setvariable variable=releaseName]app-prod"
      echo "##vso[task.setvariable variable=namespace]prod"
    fi
  displayName: 'Set releaseName and namespace dynamically'

# 2ï¸âƒ£ Debug (verify variables)
- script: |
    echo "releaseName=$(releaseName)"
    echo "namespace=$(namespace)"
  displayName: 'Debug variables'

# BLOQUE 2: Update Helm values.yaml and push to GitHub via SSH
# BLOQUE 2: Update Helm values.yaml and push to GitHub via SSH
- bash: |
    set -e  # Salir si hay cualquier error

    echo "=== ðŸ”§ Updating values.yaml for branch $(Build.SourceBranchName) with tag $(tag) ==="

    # Elegir archivo segÃºn branch
    if [ "$(Build.SourceBranchName)" == "dev" ]; then
      envPath="envs/dev/values.yaml"
    else
      envPath="envs/prod/values.yaml"
    fi

    # Actualizar tag en values.yaml
    sed -i "s|tag: .*|tag: $(tag)|" "$envPath"
    echo "âœ… Updated $envPath with tag $(tag)"

    # Configurar Git
    git config user.email "pipeline@azuredevops.local"
    git config user.name "Azure Pipelines"
    git add "$envPath"
    git commit -m "Update image tag to $(tag)" || echo "No changes to commit"

    # Configurar SSH correctamente
    mkdir -p ~/.ssh
    # Decodificar correctamente la variable base64
    echo "$SSH_PRIVATE_KEY" | tr -d '\r\n' | base64 --decode > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa

    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_rsa

    # Confiar en GitHub para evitar prompts
    ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

    # Asegurarse que origin apunta al repositorio correcto
    git remote set-url origin git@github.com:jreb-123/k8s-lab-week1.git

    # Hacer pull para no tener conflictos y push del commit
    git pull origin $(Build.SourceBranchName) --rebase || true
    git push origin HEAD:$(Build.SourceBranchName)

  displayName: 'Update Helm values.yaml and push to GitHub via SSH'
  env:
    SSH_PRIVATE_KEY: $(SSH_PRIVATE_KEY)
