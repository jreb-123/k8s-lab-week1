trigger:
  branches:
    include:
      - main
      - dev

pool:
  name: Default   # Tu agente local

variables:
  - name: imageName
    value: 'jrebaza01/app-week1'
  - name: tag
    value: $(Build.SourceVersion)

  # üí° Estas dos variables se calculan din√°micamente
  - name: releaseName
    ${{ if eq(variables['Build.SourceBranchName'], 'dev') }}:
      value: 'app-dev'
    ${{ else }}:
      value: 'app-prod'

  - name: namespace
    ${{ if eq(variables['Build.SourceBranchName'], 'dev') }}:
      value: 'dev'
    ${{ else }}:
      value: 'prod'

steps:
# 1Ô∏è‚É£ Checkout del c√≥digo
- checkout: self
  clean: true

# 2Ô∏è‚É£ Login en Docker Hub
- task: Docker@2
  displayName: 'Login to Docker Hub'
  inputs:
    command: login
    containerRegistry: 'DockerHubService'

# 3Ô∏è‚É£ Build de la imagen Docker
- task: Docker@2
  displayName: 'Build Docker image'
  inputs:
    command: build
    Dockerfile: '$(Build.SourcesDirectory)/app/Dockerfile'
    buildContext: '$(Build.SourcesDirectory)/app'
    tags: |
      $(imageName):$(tag)

# 4Ô∏è‚É£ Push de la imagen a Docker Hub
- task: Docker@2
  displayName: 'Push Docker image'
  inputs:
    command: push
    containerRegistry: 'DockerHubService'
    tags: |
      $(imageName):$(tag)

# 5Ô∏è‚É£ Actualizar values.yaml con el nuevo tag y hacer push a GitHub
- powershell: |
    Write-Host "Actualizando values.yaml con el nuevo tag $(tag)..."

    $filePath = "$(Build.SourcesDirectory)/charts/app/values.yaml"
    (Get-Content $filePath) -replace 'tag: .*', "tag: $(tag)" | Set-Content $filePath

    git config user.email "ci@azurepipelines.com"
    git config user.name "Azure Pipelines"

    git checkout $(Build.SourceBranchName)
    git add charts/app/values.yaml
    git commit -m "Update image tag to $(tag)"
    git push origin $(Build.SourceBranchName)
  displayName: "Update Helm values and push to GitHub"

# 6Ô∏è‚É£ Desplegar con Helm
- task: HelmDeploy@0
  displayName: "Deploy app with Helm"
  inputs:
    connectionType: 'None'
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: '$(Build.SourcesDirectory)/charts/app'
    releaseName: '$(releaseName)'
    namespace: '$(namespace)'
    overrideValues: |
      image.tag=$(tag)
    install: true
