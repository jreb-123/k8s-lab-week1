trigger:
  branches:
    include:
      - main
      - dev

pool:
  name: Default   # Tu agente local

variables:
  imageName: 'jrebaza01/app-week1'   # Docker Hub
  tag: $(Build.SourceVersion)        # Tag dinámico según commit

steps:

# 1️⃣ Checkout
- checkout: self

# 2️⃣ Login a Docker Hub
- task: Docker@2
  displayName: 'Login to Docker Hub'
  inputs:
    command: login
    containerRegistry: 'DockerHubService'

# 3️⃣ Build Docker image
- task: Docker@2
  displayName: 'Build Docker image'
  inputs:
    command: build
    Dockerfile: '$(Build.SourcesDirectory)/app/Dockerfile'
    buildContext: '$(Build.SourcesDirectory)/app'
    tags: |
      $(imageName):$(tag)-$(Build.SourceBranchName)

# 4️⃣ Push Docker image
- task: Docker@2
  displayName: 'Push Docker image'
  inputs:
    command: push
    containerRegistry: 'DockerHubService'
    tags: |
      $(imageName):$(tag)-$(Build.SourceBranchName)

# 5️⃣ Actualizar values.yaml
- powershell: |
    Write-Host "Actualizando values.yaml con el nuevo tag..."
    (Get-Content "$(Build.SourcesDirectory)/charts/app/values.yaml") `
    -replace 'tag: .*', "tag: $(tag)-$(Build.SourceBranchName)" | Set-Content "$(Build.SourcesDirectory)/charts/app/values.yaml"

    git config user.email "ci@azurepipelines.com"
    git config user.name "Azure Pipelines"
    git add charts/app/values.yaml
    git commit -m "Update image tag to $(tag)-$(Build.SourceBranchName)" -ErrorAction SilentlyContinue

    git push origin $(Build.SourceBranchName)
  displayName: "Update Helm values and push to GitHub"
