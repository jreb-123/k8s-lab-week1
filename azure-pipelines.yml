trigger:
  branches:
    include:
      - dev
      - main

pool:
  name: default   # tu agente Ubuntu

variables:
  imageName: 'jrebaza01/app-week1'
  tag: $(Build.SourceVersion)

steps:

# 1️⃣ Variables dinámicas según rama
- script: |
    if [ "$(Build.SourceBranchName)" == "refs/heads/dev" ]; then
      echo "##vso[task.setvariable variable=releaseName]app-dev"
      echo "##vso[task.setvariable variable=namespace]dev"
    else
      echo "##vso[task.setvariable variable=releaseName]app-prod"
      echo "##vso[task.setvariable variable=namespace]prod"
    fi
  displayName: 'Set releaseName and namespace dynamically'

# 2️⃣ Build de la imagen Docker
- task: Docker@2
  displayName: 'Build Docker image'
  inputs:
    command: build
    Dockerfile: '$(Build.SourcesDirectory)/app/Dockerfile'
    buildContext: '$(Build.SourcesDirectory)/app'
    tags: |
      $(imageName):$(tag)

# 3️⃣ Push a Docker Hub
- task: Docker@2
  displayName: 'Push Docker image to Docker Hub'
  inputs:
    command: push
    tags: |
      $(imageName):$(tag)

# 4️⃣ Update values.yaml y push a GitHub
- script: |
    echo "Updating values.yaml for branch $(Build.SourceBranchName) with tag $(tag)..."
    if [ "$(Build.SourceBranchName)" == "refs/heads/dev" ]; then
      envPath="envs/dev/values.yaml"
    else
      envPath="envs/prod/values.yaml"
    fi

    sed -i "s|tag: .*|tag: $(tag)|" $envPath

    # Configuración git para usar token
    git config user.email "pipeline@azuredevops.local"
    git config user.name "Azure Pipelines"
    git remote set-url origin https://$(GH_TOKEN)@github.com/jreb-123/k8s-lab-week1.git

    git add $envPath
    git commit -m "Update image tag to $(tag)" || echo "No changes to commit"
    git pull origin $(Build.SourceBranchName) --rebase
    git push origin HEAD:$(Build.SourceBranchName)
  displayName: 'Update Helm values.yaml and push to GitHub'
  env:
    GH_TOKEN: $(GH_TOKEN)

# 5️⃣ Deploy con Helm y rollback automático
- script: |
    set -e  # Exit if any command fails

    echo "Deploying to Kubernetes..."
    helm upgrade --namespace $(namespace) \
      --install \
      --set image.repository=$(imageName),image.tag=$(tag) \
      --create-namespace \
      $(releaseName) $(Build.SourcesDirectory)/charts/app || \
    { echo "Helm upgrade failed, rolling back..."; helm rollback $(releaseName) 0 --namespace $(namespace); exit 1; }
  displayName: 'Deploy to Kubernetes via Helm with rollback'



